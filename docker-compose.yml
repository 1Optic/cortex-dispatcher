version: "3.2"

volumes:
  grafana_data:
  home:
  rabbitmq-database:

services:
  rabbitmq:
    image: rabbitmq:4.0-management@sha256:6a93c25cb0318f52178ea9befd2927794f9d35741133478e2f1bc1010b25706f
    ports:
      - 127.0.0.1:5672:5672
      - 127.0.0.1:15672:15672
    volumes:
      - ./dev-stack/rabbitmq.conf:/etc/rabbitmq/conf.d/20-dev.conf
      - ./dev-stack/definitions.json:/etc/rabbitmq/definitions.json
      - rabbitmq-database:/var/lib/rabbitmq

  sftp:
    image: atmoz/sftp@sha256:0960390462a4441dbb63698d7c185b76a41ffcee7b78ff4adf275f3e66f9c475
    ports:
      - "127.0.0.1:2222:22"
    command: cortex:password:::upload
    volumes:
      - home:/home/cortex

  prometheus:
    image: prom/prometheus@sha256:9abc6cf6aea7710d163dbb28d8eeb7dc5baef01e38fa4cd146a406dd9f07f70d
    ports:
      - 127.0.0.1:9090:9090
    volumes:
      - ./dev-stack/prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana@sha256:6ac590e7cabc2fbe8d7b8fc1ce9c9f0582177b334e0df9c927ebd9670469440f
    ports:
      - 127.0.0.1:3000:3000
    volumes:
      - grafana_data:/var/lib/grafana
      - ./dev-stack/grafana/provisioning/:/etc/grafana/provisioning/

  pg_prometheus:
    image: timescale/pg_prometheus:latest-pg11@sha256:612b5342b122e424dea323ed70393e9c1cef3553cf59da6595254cb20fbfc454
    command: ["postgres", "-csynchronous_commit=off"]
    ports:
      - 127.0.0.1:5432:5432
    volumes:
      - ./dev-stack/pg_prometheus/docker-entrypoint-initdb.d/004-init-cortex-db.sh:/docker-entrypoint-initdb.d/004-init-cortex-db.sh
      - ./db/schema.sql:/schema.sql
    environment:
      POSTGRES_PASSWORD: "password"

  adapter:
    image: timescale/prometheus-postgresql-adapter:latest@sha256:ea3c4dfb9d55e824e0376e3beaa3cbc261eb8d026682257139da1a81148c39d9
    command: ["-pg-host=pg_prometheus", "-pg-password=password", "-pg-prometheus-log-samples"]

  generator:
    build: dev-stack/data-generator
    environment:
      SFTP_HOST: sftp
      SFTP_PORT: 22
      SFTP_USERNAME: cortex
      SFTP_PASSWORD: password
